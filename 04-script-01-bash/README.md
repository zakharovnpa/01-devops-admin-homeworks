# Домашнее задание к занятию "4.1. Командная оболочка Bash: Практические навыки" - Захаров Сергей Николаевич

## Обязательные задания

### 1. Есть скрипт:
```bash
	a=1
	b=2
	c=a+b
	d=$a+$b
	e=$(($a+$b))
```
	* Какие значения переменным c,d,e будут присвоены?
	* Почему?
	
   **Ответ:**
   
   * для $с будет присвоено значение ` a+b `, т.к. мы сами задали $c строковое значение
   * для $d будет присвоено значение ` 1+2 `, т.к. для $a и $b было присвоено нетипизированное значение, которое считается строкой, а строки не суммируются. В итоге получится: символ 1, символ +, символ 2.
   * для $e будет присвоено значение ` 3 `, т.к. двойные скобки ` (($a+$b)) ` - команда для проебразования 1 и 2 в числа и операцию суммирования. Также работают ` [$a+$b] `

### 2. На нашем локальном сервере упал сервис и мы написали скрипт, который постоянно проверяет его доступность, записывая дату проверок до тех пор, пока сервис не станет доступным. В скрипте допущена ошибка, из-за которой выполнение не может завершиться, при этом место на Жёстком Диске постоянно уменьшается. Что необходимо сделать, чтобы его исправить:

 ```bash
	while ((1==1)
	do
	curl https://localhost:4757
	if (($? != 0))
	then
	date >> curl.log
	fi
	done
 ```
   **Ответ:**

   * Необходмо в первой строке скрипта вместо однарной скобки ` ) ` поставить двойную скобку ` )) `. Иначе bash не сможет сделать арифметическую операцию сравнения ` ((1==1)) `
   * Необходимо добавить условие выхода из цикла ` else exit ` в том случае, если команда ` curl https://localhost:4757 ` завершится успешно. 
   * Необходимо добавить интервал проверки доступности, которого сейчас нет. Например, командой sleep. Иначе файл логов будет быстро расти.

  
  Результат:

```bash
# Добавляем последнюю закрывающую скобку
    while (( 1 == 1 ))
#
#
    do
        curl https://localhost:4757
        if (($? != 0))
        then
            date >> curl.log
# Добавляем условия для выхода из цикла
        else exit
#
#
        fi
# Добавляем интервал запуска скрипта
        sleep 10
#
#
    done
```

### 3. Необходимо написать скрипт, который проверяет доступность трёх IP: 192.168.0.1, 173.194.222.113, 87.250.250.242 по 80 порту и записывает результат в файл log. Проверять доступность необходимо пять раз для каждого узла.

   **Ответ:**
   
```bash
#!/usr/bin/env bash

#Создаем массив из адресов для проверки доступности сайтов
#ya.ru Addresses: 87.250.250.242
#mail.ru Addresses: 217.69.139.200
#alnado.ru Address:  141.8.192.238
#
test_hosts=(87.250.250.242 217.69.139.200 141.8.192.238)

#Присвиваем переменной timeout значение 5
timeout=5

#Создаем цикл for с переменной i
# i- это имя переменной, значение которой будет увеличиваться в ходе выполнения цикла,
# в скобках —  список элементов, которые последовательно будут присваиваться переменной i. По заданию - 5 циклов
	for i in {1..5}


#Создаем список выполняемых команд в цикле
	do

#Записывать в лог системное время начала выполнения проверки доступности
	date >>availability_hosts.log

#Создаем цикл for с переменной h, которой будут присваиваться последовательно значения адресов из массива test_hosts
#они будут выведены все и сразу
    		for h in ${test_hosts[@]}

#Создаем список выполняемых команд в цикле for h
    		do

#Утилитой curl через каждые 5 секунд подключаемся к сайтам из массива на порт 80, результат вывода команды уничтожаем
        		curl -Is --connect-timeout $timeout $h:80 >/dev/null

#Проверка условия неравности нулю кода результата выполнения команды curl
			if (($? != 0))

#Если $? не равен нулю, то хост считается недоступным и сделать запись в файл логов
        		then
                        echo " - host:" $h - status DOWN >>availability_hosts.log
#Иначе если $? равен нулю, то хост считается доступными сделать запись в файл логов
                	else
                        echo " - host:" $h - status UP >>availability_hosts.log

#Выход из цикла for h
        		fi

#Окончание условия для цикла for h
        	done

#Окончание условия для цикла for i
	done
```

Читаем логи:
```bash
root@vagrant:~/TMP# cat availability_hosts.log
Tue 09 Nov 2021 04:46:19 PM UTC
 - host: 87.250.250.242 - status UP
 - host: 217.69.139.200 - status UP
 - host: 141.8.192.238 - status DOWN
Tue 09 Nov 2021 04:46:24 PM UTC
 - host: 87.250.250.242 - status UP
 - host: 217.69.139.200 - status UP
 - host: 141.8.192.238 - status DOWN
Tue 09 Nov 2021 04:46:29 PM UTC
 - host: 87.250.250.242 - status UP
 - host: 217.69.139.200 - status UP
 - host: 141.8.192.238 - status DOWN
Tue 09 Nov 2021 04:46:34 PM UTC
 - host: 87.250.250.242 - status UP
 - host: 217.69.139.200 - status UP
 - host: 141.8.192.238 - status DOWN
Tue 09 Nov 2021 04:46:39 PM UTC
 - host: 87.250.250.242 - status UP
 - host: 217.69.139.200 - status UP
 - host: 141.8.192.238 - status DOWN

```
### 4. Необходимо дописать скрипт из предыдущего задания так, чтобы он выполнялся до тех пор, пока один из узлов не окажется недоступным. Если любой из узлов недоступен - IP этого узла пишется в файл error, скрипт прерывается

   **Ответ:**
   
```bash
#!/usr/bin/env bash

test_hosts=(87.250.250.242 217.69.139.200 141.8.192.238)
timeout=5

        for i in {1..5}

        do
                for h in ${test_hosts[@]}
                do
                        curl -Is --connect-timeout $timeout $h:80 >/dev/null
                        if (($? != 0))

#Если $? не равен нулю, то хост считается недоступным. Сделать записи о времени события и ip адресе хоста 
#в файл логов и остановить выполнение скрипта
                        then
                        date >>error.log && echo $h >>error.log && exit
                        fi
                done
done
```

Смотрим файл error.log
```bash
root@vagrant:~/TMP# cat error.log
Tue 09 Nov 2021 05:53:09 PM UTC
141.8.192.238
Tue 09 Nov 2021 05:55:19 PM UTC
141.8.192.238
Tue 09 Nov 2021 05:55:27 PM UTC
141.8.192.238
```

## Дополнительное задание (со звездочкой*) - необязательно к выполнению

Мы хотим, чтобы у нас были красивые сообщения для коммитов в репозиторий. Для этого нужно написать локальный хук для git, который будет проверять, что сообщение в коммите содержит код текущего задания в квадратных скобках и количество символов в сообщении не превышает 30. Пример сообщения: \[04-script-01-bash\] сломал хук.

   **Ответ:**

---

Утилиты из лекции:
let
let is a shell builtin

 type declare
declare is a shell builtin

type set
set is a shell builtin



